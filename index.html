<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Bot Codes Marketplace</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <!-- Uploadcare widget -->
    <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #1f2937, #374151);
        }

        .btn {
            @apply px-6 py-3 rounded-full font-bold transition-all duration-300 transform hover:scale-105;
        }

        .btn-primary {
            @apply bg-blue-600 text-white shadow-lg hover:bg-blue-700;
        }

        .btn-secondary {
            @apply bg-gray-700 text-gray-200 shadow-md hover:bg-gray-800;
        }
        
        /* Custom styles for Uploadcare widget to match theme */
        .uploadcare--widget {
            background-color: #2d3748 !important;
            border-color: #4a5568 !important;
            color: #e2e8f0 !important;
            border-radius: 0.5rem;
        }

        .uploadcare--widget__button {
            background-color: #4299e1 !important;
            color: white !important;
        }

        .uploadcare--widget__button:hover {
            background-color: #2b6cb0 !important;
        }

        /* Message box styling */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            min-width: 300px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center">

    <!-- Message Box -->
    <div id="message-box" class="message-box hidden">
        <div id="message-content" class="text-center font-semibold"></div>
        <button id="close-message" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-full">OK</button>
    </div>

    <!-- Main Container -->
    <div id="app" class="w-full h-full flex flex-col items-center">

        <!-- Splash Screen / Landing Page -->
        <section id="splash-page" class="flex flex-col items-center justify-center min-h-screen w-full px-4 text-center">
            <div class="gradient-bg rounded-3xl p-8 md:p-12 lg:p-16 max-w-4xl mx-auto shadow-2xl transition-all duration-500 transform hover:scale-105">
                <h1 class="text-4xl md:text-6xl font-extrabold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-500 animate-pulse">
                    The Ultimate Telegram Bot Codes Marketplace
                </h1>
                <p class="text-lg md:text-xl text-gray-300 leading-relaxed mb-8">
                    Discover and acquire high-quality, pre-built Telegram bot codes designed to automate tasks, enhance user experience, and monetize your channels. Our codes are verified, secure, and ready to deploy.
                </p>
                <div class="space-y-4 md:space-y-0 md:space-x-4">
                    <button id="get-started-btn" class="btn btn-primary">
                        Get Started
                    </button>
                    <button id="help-btn" class="btn btn-secondary">
                        <i class="fas fa-question-circle mr-2"></i> Help
                    </button>
                </div>
            </div>
        </section>

        <!-- Auth Page (Sign Up & Login) -->
        <section id="auth-page" class="hidden flex-col items-center justify-center min-h-screen w-full px-4">
            <div class="bg-gray-800 rounded-2xl p-8 max-w-md w-full shadow-xl transition-all duration-500 transform hover:scale-105">
                <h2 id="auth-title" class="text-3xl font-bold mb-6 text-center text-blue-400">Sign Up</h2>
                <form id="auth-form" class="space-y-6">
                    <div>
                        <label for="auth-email" class="block text-sm font-medium text-gray-400">Email Address</label>
                        <input type="email" id="auth-email" required class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-white">
                    </div>
                    <div>
                        <label for="auth-password" class="block text-sm font-medium text-gray-400">Password</label>
                        <input type="password" id="auth-password" required class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-white">
                    </div>
                    <button type="submit" id="auth-submit-btn" class="w-full btn btn-primary">Sign Up</button>
                </form>
                <div class="text-center mt-4 text-sm text-gray-400">
                    <p id="toggle-auth-text">Already have an account? <button id="toggle-auth-btn" class="text-blue-400 hover:underline">Login</button></p>
                </div>
            </div>
        </section>
        
        <!-- Products Page -->
        <section id="products-page" class="hidden min-h-screen w-full p-6">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-3xl md:text-4xl font-bold text-blue-400">Our Bot Codes</h2>
                <button id="logout-btn" class="btn btn-secondary text-sm">Logout</button>
            </header>
            <div id="products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Product cards will be dynamically inserted here -->
            </div>
        </section>

        <!-- Payment Verification Page -->
        <section id="payment-page" class="hidden min-h-screen w-full flex-col items-center justify-center p-6 text-center">
            <div class="bg-gray-800 rounded-2xl p-8 max-w-lg w-full shadow-xl">
                <h2 class="text-3xl font-bold mb-4 text-blue-400">Payment Verification</h2>
                <p class="text-gray-300 mb-6">Please pay using the UPI details below and upload your payment screenshot for verification.</p>
                <div class="bg-gray-900 rounded-xl p-6 mb-6">
                    <img id="upi-qr" src="https://placehold.co/400x400/2d3748/e2e8f0?text=Scan+to+Pay" alt="UPI QR Code" class="w-48 h-48 mx-auto rounded-lg mb-4">
                    <p class="font-semibold text-lg text-blue-300">UPI ID: shebinraju2021@upi</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-400 mb-2">Upload Payment Screenshot</label>
                    <input type="hidden" id="file-uploader" role="uploadcare-uploader" data-public-key="YOUR_UPLOADCARE_PUBLIC_KEY" data-multiple="false" data-images-only="true" />
                </div>
                <button id="submit-payment-btn" class="w-full btn btn-primary disabled:opacity-50" disabled>Submit for Verification</button>
                <button id="back-to-products-btn" class="w-full mt-4 btn btn-secondary">Back to Codes</button>
            </div>
        </section>

        <!-- Owner Dashboard Page -->
        <section id="owner-dashboard-page" class="hidden min-h-screen w-full p-6">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-3xl md:text-4xl font-bold text-blue-400">Owner Dashboard</h2>
                <button id="admin-logout-btn" class="btn btn-secondary text-sm">Logout</button>
            </header>
            <div class="bg-gray-800 rounded-2xl p-6 shadow-xl mb-6">
                <h3 class="text-xl font-bold mb-4 text-gray-300">Add New Bot Code</h3>
                <form id="add-product-form" class="space-y-4">
                    <div>
                        <label for="bot-name" class="block text-sm font-medium text-gray-400">Bot Name</label>
                        <input type="text" id="bot-name" required class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-white">
                    </div>
                    <div>
                        <label for="bot-description" class="block text-sm font-medium text-gray-400">Description</label>
                        <textarea id="bot-description" required rows="3" class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-white"></textarea>
                    </div>
                    <div>
                        <label for="bot-price" class="block text-sm font-medium text-gray-400">Price ($)</label>
                        <input type="number" id="bot-price" required class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Upload Bot Code (zip file)</label>
                        <input type="hidden" id="code-uploader" role="uploadcare-uploader" data-public-key="YOUR_UPLOADCARE_PUBLIC_KEY" data-multiple="false" />
                    </div>
                    <button type="submit" id="add-product-btn" class="w-full btn btn-primary disabled:opacity-50">Add Bot Code</button>
                </form>
            </div>
            <div class="bg-gray-800 rounded-2xl p-6 shadow-xl mb-6">
                <h3 class="text-xl font-bold mb-4 text-gray-300">Payment Requests</h3>
                <div id="payment-requests-list" class="space-y-4">
                    <!-- Payment requests will be dynamically inserted here -->
                </div>
            </div>
        </section>

        <!-- Help Section -->
        <section id="help-section" class="hidden min-h-screen w-full flex-col items-center justify-center p-6 text-center">
            <div class="bg-gray-800 rounded-2xl p-8 max-w-lg w-full shadow-xl">
                <h2 class="text-3xl font-bold mb-4 text-blue-400">Need Help?</h2>
                <p class="text-gray-300 mb-6">If you have any questions or need assistance with your purchase, please don't hesitate to reach out.</p>
                <p class="text-lg font-semibold text-gray-200">
                    <i class="fab fa-telegram-plane mr-2"></i> Telegram: <a href="https://t.me/shebinraju" target="_blank" class="text-blue-400 hover:underline">@shebinraju</a>
                </p>
                <button id="back-from-help-btn" class="w-full mt-6 btn btn-secondary">Back to Home</button>
            </div>
        </section>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const JSONBIN_API_KEY = "YOUR_JSONBIN_API_KEY"; // Replace with your actual JSONBin.io private API key (X-Master-Key)
            const JSONBIN_URL = "https://api.jsonbin.io/v3/b/68d0069143b1c97be94a639a"; // JSONBin ID for all user data
            const UPLOADCARE_PUBLIC_KEY = "YOUR_UPLOADCARE_PUBLIC_KEY"; // Replace with your Uploadcare Public Key
            const UPLOADCARE_SECRET_KEY = "YOUR_UPLOADCARE_SECRET_KEY"; // Replace with your Uploadcare Secret Key

            // UI elements
            const app = document.getElementById('app');
            const splashPage = document.getElementById('splash-page');
            const authPage = document.getElementById('auth-page');
            const productsPage = document.getElementById('products-page');
            const paymentPage = document.getElementById('payment-page');
            const ownerDashboardPage = document.getElementById('owner-dashboard-page');
            const helpSection = document.getElementById('help-section');
            const messageBox = document.getElementById('message-box');
            const messageContent = document.getElementById('message-content');
            const closeMessageBtn = document.getElementById('close-message');

            const getStartedBtn = document.getElementById('get-started-btn');
            const helpBtn = document.getElementById('help-btn');
            const authForm = document.getElementById('auth-form');
            const authTitle = document.getElementById('auth-title');
            const authSubmitBtn = document.getElementById('auth-submit-btn');
            const toggleAuthBtn = document.getElementById('toggle-auth-btn');
            const toggleAuthText = document.getElementById('toggle-auth-text');
            const logoutBtn = document.getElementById('logout-btn');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            const productsList = document.getElementById('products-list');
            const fileUploader = document.getElementById('file-uploader');
            const submitPaymentBtn = document.getElementById('submit-payment-btn');
            const backToProductsBtn = document.getElementById('back-to-products-btn');
            const paymentRequestsList = document.getElementById('payment-requests-list');
            const backFromHelpBtn = document.getElementById('back-from-help-btn');
            const addProductForm = document.getElementById('add-product-form');
            const codeUploader = document.getElementById('code-uploader');

            let currentUser = null;
            let currentBotCode = null;
            let isLoginMode = false;
            
            // Set up Uploadcare widget public key
            if (UPLOADCARE_PUBLIC_KEY === "YOUR_UPLOADCARE_PUBLIC_KEY") {
                console.error("Please replace 'YOUR_UPLOADCARE_PUBLIC_KEY' with your actual Uploadcare public key.");
            } else {
                uploadcare.init({ public_key: UPLOADCARE_PUBLIC_KEY });
            }
            
            // Event Listeners
            getStartedBtn.addEventListener('click', () => showPage('auth'));
            helpBtn.addEventListener('click', () => showPage('help'));
            backFromHelpBtn.addEventListener('click', () => showPage('splash'));
            toggleAuthBtn.addEventListener('click', () => toggleAuthMode());
            authForm.addEventListener('submit', handleAuth);
            logoutBtn.addEventListener('click', handleLogout);
            adminLogoutBtn.addEventListener('click', handleLogout);
            backToProductsBtn.addEventListener('click', () => showPage('products'));
            submitPaymentBtn.addEventListener('click', submitPaymentRequest);
            closeMessageBtn.addEventListener('click', () => messageBox.classList.add('hidden'));
            addProductForm.addEventListener('submit', handleAddProduct);

            // Uploadcare event listener for payment screenshot
            if (fileUploader) {
                const widget = uploadcare.Widget(fileUploader);
                widget.onDialogOpen(() => {
                    submitPaymentBtn.disabled = true;
                });
                widget.onUploadComplete((info) => {
                    const fileUrl = info.cdnUrl;
                    submitPaymentBtn.disabled = false;
                    submitPaymentBtn.dataset.fileUrl = fileUrl;
                });
            }

            // Uploadcare event listener for code upload
            if (codeUploader) {
                const widget = uploadcare.Widget(codeUploader);
                widget.onDialogOpen(() => {
                    document.getElementById('add-product-btn').disabled = true;
                });
                widget.onUploadComplete((info) => {
                    const fileUrl = info.cdnUrl;
                    document.getElementById('add-product-btn').disabled = false;
                    document.getElementById('add-product-form').dataset.fileUrl = fileUrl;
                });
            }


            // --- Core Functions ---

            function showPage(pageId) {
                // Hide all pages
                splashPage.classList.add('hidden');
                authPage.classList.add('hidden');
                productsPage.classList.add('hidden');
                paymentPage.classList.add('hidden');
                ownerDashboardPage.classList.add('hidden');
                helpSection.classList.add('hidden');

                // Show the requested page
                switch(pageId) {
                    case 'splash':
                        splashPage.classList.remove('hidden');
                        break;
                    case 'auth':
                        authPage.classList.remove('hidden');
                        break;
                    case 'products':
                        productsPage.classList.remove('hidden');
                        renderProducts();
                        break;
                    case 'payment':
                        paymentPage.classList.remove('hidden');
                        break;
                    case 'owner-dashboard':
                        ownerDashboardPage.classList.remove('hidden');
                        renderPaymentRequests();
                        break;
                    case 'help':
                        helpSection.classList.remove('hidden');
                        break;
                }
            }

            function showMessage(message, type = 'info') {
                messageContent.textContent = message;
                messageBox.classList.remove('hidden');
                if (type === 'error') {
                    messageBox.style.backgroundColor = '#9b2c2c';
                } else if (type === 'success') {
                    messageBox.style.backgroundColor = '#2f855a';
                } else {
                    messageBox.style.backgroundColor = '#2d3748';
                }
            }

            async function fetchData() {
                try {
                    const response = await fetch(JSONBIN_URL + "/latest", {
                        headers: {
                            'X-Master-Key': JSONBIN_API_KEY
                        }
                    });
                    if (!response.ok) throw new Error("Failed to fetch data from jsonbin.");
                    const data = await response.json();
                    return data.record;
                } catch (error) {
                    console.error("Error fetching data:", error);
                    showMessage("Failed to load data. Please try again.", 'error');
                    return null;
                }
            }

            async function updateData(data) {
                try {
                    const response = await fetch(JSONBIN_URL, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': JSONBIN_API_KEY
                        },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) throw new Error("Failed to update data in jsonbin.");
                    const result = await response.json();
                    return result.record;
                } catch (error) {
                    console.error("Error updating data:", error);
                    showMessage("Failed to save data. Please try again.", 'error');
                    return null;
                }
            }

            function toggleAuthMode() {
                isLoginMode = !isLoginMode;
                authTitle.textContent = isLoginMode ? 'Login' : 'Sign Up';
                authSubmitBtn.textContent = isLoginMode ? 'Login' : 'Sign Up';
                toggleAuthText.innerHTML = isLoginMode 
                    ? `Don't have an account? <button id="toggle-auth-btn" class="text-blue-400 hover:underline">Sign Up</button>`
                    : `Already have an account? <button id="toggle-auth-btn" class="text-blue-400 hover:underline">Login</button>`;
                document.getElementById('toggle-auth-btn').addEventListener('click', toggleAuthMode);
            }

            async function handleAuth(event) {
                event.preventDefault();
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;

                if (email === 'shebinraju2021@gmail.com' && password === 'adminworld16') {
                    currentUser = { email: email, role: 'admin' };
                    showMessage("Welcome, Admin! Redirecting to dashboard...", 'success');
                    setTimeout(() => showPage('owner-dashboard'), 1500);
                    return;
                }

                const data = await fetchData();
                if (!data) return;

                if (isLoginMode) {
                    // Login Logic
                    const user = data.users.find(u => u.email === email && u.password === password);
                    if (user) {
                        currentUser = user;
                        showMessage("Login successful! Redirecting...", 'success');
                        setTimeout(() => showPage('products'), 1500);
                    } else {
                        showMessage("Invalid email or password. Please try again.", 'error');
                    }
                } else {
                    // Sign Up Logic
                    const userExists = data.users.some(u => u.email === email);
                    if (userExists) {
                        showMessage("This email is already registered. Please login instead.", 'error');
                    } else {
                        const newUser = { email, password, payments: [] };
                        data.users.push(newUser);
                        const result = await updateData(data);
                        if (result) {
                            currentUser = newUser;
                            showMessage("Sign up successful! Redirecting to products...", 'success');
                            setTimeout(() => showPage('products'), 1500);
                        }
                    }
                }
            }

            function handleLogout() {
                currentUser = null;
                isLoginMode = false;
                toggleAuthMode();
                showPage('splash');
                showMessage("Logged out successfully.", 'info');
            }

            async function renderProducts() {
                productsList.innerHTML = '<p class="text-center text-gray-400">Loading products...</p>';
                const data = await fetchData();
                if (!data || !data.products || data.products.length === 0) {
                    productsList.innerHTML = '<p class="text-center text-gray-400">No bot codes are available at the moment.</p>';
                    return;
                }

                productsList.innerHTML = '';
                data.products.forEach(bot => {
                    const isPaid = currentUser && currentUser.payments.some(p => p.productId === bot.id && p.status === 'accepted');
                    const isPending = currentUser && currentUser.payments.some(p => p.productId === bot.id && p.status === 'pending');
                    
                    const card = document.createElement('div');
                    card.classList.add('bg-gray-800', 'rounded-2xl', 'p-6', 'shadow-xl', 'transition-all', 'duration-300', 'transform', 'hover:scale-105');
                    card.innerHTML = `
                        <h3 class="text-2xl font-bold mb-2 text-blue-400">${bot.name}</h3>
                        <p class="text-gray-300 mb-4">${bot.description}</p>
                        <div class="flex items-center justify-between mt-4">
                            <span class="text-xl font-bold text-gray-200">$${bot.price}</span>
                            <button class="btn ${isPaid || isPending ? 'btn-secondary opacity-50 cursor-not-allowed' : 'btn-primary'}"
                                data-id="${bot.id}"
                                data-code-url="${bot.codeUrl}"
                                ${isPaid || isPending ? 'disabled' : ''}
                            >
                                ${isPaid ? 'Download' : (isPending ? 'Pending' : 'Buy')}
                            </button>
                        </div>
                    `;
                    productsList.appendChild(card);
                });

                document.querySelectorAll('#products-list .btn-primary').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const botId = event.target.dataset.id;
                        currentBotCode = data.products.find(bot => bot.id === botId);
                        showPage('payment');
                    });
                });

                document.querySelectorAll('#products-list .btn-secondary').forEach(button => {
                     if (button.textContent === 'Download') {
                        button.addEventListener('click', (event) => {
                            const codeUrl = event.target.dataset.codeUrl;
                            if (codeUrl) {
                                window.open(codeUrl, '_blank');
                                showMessage("Downloading your code...", 'info');
                            } else {
                                showMessage("Code file not found.", 'error');
                            }
                        });
                    }
                });
            }

            async function submitPaymentRequest() {
                if (!submitPaymentBtn.dataset.fileUrl) {
                    showMessage("Please upload your payment screenshot first.", 'error');
                    return;
                }
                
                const data = await fetchData();
                if (!data) return;

                const userIndex = data.users.findIndex(u => u.email === currentUser.email);
                if (userIndex === -1) {
                    showMessage("User not found. Please log in again.", 'error');
                    return;
                }
                
                const requestId = `${currentUser.email}-${Date.now()}`;
                
                const newPaymentRequest = {
                    id: currentBotCode.id,
                    requestId: requestId,
                    botName: currentBotCode.name,
                    userEmail: currentUser.email,
                    screenshotUrl: submitPaymentBtn.dataset.fileUrl,
                    status: 'pending',
                    timestamp: new Date().toISOString()
                };

                if (!data.requests) {
                    data.requests = [];
                }
                data.requests.push(newPaymentRequest);

                data.users[userIndex].payments.push({
                    productId: currentBotCode.id,
                    status: 'pending'
                });

                const result = await updateData(data);
                if (result) {
                    showMessage("Payment request submitted successfully! We will notify you when it's verified.", 'success');
                    setTimeout(() => showPage('products'), 3000);
                }
            }
            
            async function renderPaymentRequests() {
                paymentRequestsList.innerHTML = '<p class="text-center text-gray-400">Loading requests...</p>';
                const data = await fetchData();
                if (!data || !data.requests) {
                    paymentRequestsList.innerHTML = '<p class="text-gray-400 text-center">No new payment requests.</p>';
                    return;
                }

                const pendingRequests = data.requests.filter(req => req.status === 'pending');
                if (pendingRequests.length === 0) {
                    paymentRequestsList.innerHTML = '<p class="text-gray-400 text-center">No new payment requests.</p>';
                    return;
                }

                paymentRequestsList.innerHTML = '';
                pendingRequests.forEach(req => {
                    const requestCard = document.createElement('div');
                    requestCard.classList.add('bg-gray-900', 'p-4', 'rounded-xl', 'flex', 'flex-col', 'md:flex-row', 'items-center', 'justify-between', 'space-y-4', 'md:space-y-0');
                    requestCard.innerHTML = `
                        <div class="flex-grow">
                            <p class="text-lg font-semibold text-blue-300">Request ID: ${req.requestId}</p>
                            <p><strong>Email:</strong> ${req.userEmail}</p>
                            <p><strong>Bot Code:</strong> ${req.botName}</p>
                            <a href="${req.screenshotUrl}" target="_blank" class="text-blue-400 hover:underline mt-2 inline-block">View Screenshot</a>
                        </div>
                        <div class="flex space-x-2 mt-4 md:mt-0">
                            <button class="btn btn-primary text-sm accept-btn" data-request-id="${req.requestId}" data-screenshot-url="${req.screenshotUrl}">Accept</button>
                            <button class="btn btn-secondary text-sm reject-btn" data-request-id="${req.requestId}">Reject</button>
                        </div>
                    `;
                    paymentRequestsList.appendChild(requestCard);
                });

                document.querySelectorAll('.accept-btn').forEach(button => {
                    button.addEventListener('click', handleAcceptRequest);
                });

                document.querySelectorAll('.reject-btn').forEach(button => {
                    button.addEventListener('click', handleRejectRequest);
                });
            }

            async function handleAcceptRequest(event) {
                const requestId = event.target.dataset.requestId;
                const screenshotUrl = event.target.dataset.screenshotUrl;

                const data = await fetchData();
                if (!data || !data.requests) {
                    showMessage("Error: Could not find requests.", 'error');
                    return;
                }

                const requestIndex = data.requests.findIndex(req => req.requestId === requestId);
                if (requestIndex === -1) {
                    showMessage("Error: Request not found.", 'error');
                    return;
                }

                const userIndex = data.users.findIndex(u => u.email === data.requests[requestIndex].userEmail);
                if (userIndex !== -1) {
                    const paymentIndex = data.users[userIndex].payments.findIndex(p => p.productId === data.requests[requestIndex].id);
                    if (paymentIndex !== -1) {
                         data.users[userIndex].payments[paymentIndex].status = 'accepted';
                    }
                }

                data.requests[requestIndex].status = 'accepted';

                // Attempt to delete screenshot from Uploadcare using the secure (but simulated) method.
                await deleteFileFromUploadcare(screenshotUrl);

                const result = await updateData(data);
                if (result) {
                    showMessage("Payment accepted and status updated.", 'success');
                    renderPaymentRequests(); 
                }
            }

            async function handleRejectRequest(event) {
                const requestId = event.target.dataset.requestId;

                const data = await fetchData();
                if (!data || !data.requests) {
                    showMessage("Error: Could not find requests.", 'error');
                    return;
                }

                const requestIndex = data.requests.findIndex(req => req.requestId === requestId);
                if (requestIndex === -1) {
                    showMessage("Error: Request not found.", 'error');
                    return;
                }
                
                data.requests.splice(requestIndex, 1);
                
                const userIndex = data.users.findIndex(u => u.email === data.requests[requestIndex].userEmail);
                if (userIndex !== -1) {
                    const paymentIndex = data.users[userIndex].payments.findIndex(p => p.productId === data.requests[requestIndex].id);
                    if (paymentIndex !== -1) {
                         data.users[userIndex].payments.splice(paymentIndex, 1);
                    }
                }

                const result = await updateData(data);
                if (result) {
                    showMessage("Payment request rejected.", 'info');
                    renderPaymentRequests();
                }
            }
            
            async function deleteFileFromUploadcare(fileUrl) {
                const fileId = fileUrl.split('/').filter(Boolean).pop();
                if (UPLOADCARE_SECRET_KEY === 'YOUR_UPLOADCARE_SECRET_KEY') {
                    console.error("WARNING: To delete files, you must provide your Uploadcare secret key. This is a security risk in a client-side app.");
                    showMessage("Delete failed. Please add your Uploadcare secret key to the code.", "error");
                    return;
                }

                try {
                    const response = await fetch(`https://api.uploadcare.com/files/${fileId}/`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Uploadcare.Simple ${UPLOADCARE_PUBLIC_KEY}:${UPLOADCARE_SECRET_KEY}`,
                            'Accept': 'application/vnd.uploadcare-v0.5+json'
                        }
                    });

                    if (response.ok) {
                        console.log(`Successfully deleted file with ID: ${fileId}`);
                    } else {
                        const error = await response.json();
                        console.error("Failed to delete file from Uploadcare:", error);
                        showMessage("Failed to delete screenshot. Check the console for details.", "error");
                    }
                } catch (error) {
                    console.error("Network error during file deletion:", error);
                    showMessage("Network error during file deletion. Check the console.", "error");
                }
            }

            async function handleAddProduct(event) {
                event.preventDefault();

                const botName = document.getElementById('bot-name').value;
                const botDescription = document.getElementById('bot-description').value;
                const botPrice = document.getElementById('bot-price').value;
                const codeUrl = document.getElementById('add-product-form').dataset.fileUrl;
                
                if (!codeUrl) {
                    showMessage("Please upload the bot code file.", 'error');
                    return;
                }

                const data = await fetchData();
                if (!data) return;

                if (!data.products) {
                    data.products = [];
                }

                const newProduct = {
                    id: `bot-${Date.now()}`,
                    name: botName,
                    description: botDescription,
                    price: botPrice,
                    codeUrl: codeUrl
                };

                data.products.push(newProduct);
                const result = await updateData(data);

                if (result) {
                    showMessage("New bot code added successfully!", 'success');
                    addProductForm.reset();
                    document.getElementById('add-product-form').dataset.fileUrl = '';
                    document.getElementById('add-product-btn').disabled = false;
                }
            }
        });
    </script>
</body>
</html>
